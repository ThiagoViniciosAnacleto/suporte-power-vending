<link rel="stylesheet" href="{{ url_for('static', filename='lista_chamados.css') }}">

{# Toast de mensagens flash #}
{% with mensagens = get_flashed_messages() %}
  {% if mensagens %}
    <div class="toast" id="toast">
      {{ mensagens[0] }}
    </div>
  {% endif %}
{% endwith %}

<main class="home-main">
  {# Formulário de filtros #}
  <form class="filtro-container" method="get" action="/listar" data-spa-post>
    <div class="filtro-item">
      <label for="responsavel">Responsável:</label>
      <input type="text" name="responsavel" id="responsavel" placeholder="Responsável">
    </div>

    <div class="filtro-item">
      <label for="data_inicio">Data início:</label>
      <input type="date" name="data_inicio" id="data_inicio">
    </div>

    <div class="filtro-item">
      <label for="data_fim">Data fim:</label>
      <input type="date" name="data_fim" id="data_fim">
    </div>

    <div class="filtro-item">
      <label for="cliente">Cliente:</label>
      <input type="text" name="cliente" id="cliente" placeholder="Nome do cliente">
    </div>

    <div class="filtro-item">
      <label for="empresa">Empresa:</label>
      <input type="text" name="empresa" id="empresa" placeholder="Nome da empresa">
    </div>

    <div class="filtro-item">
      <label for="status">Status:</label>
      <select name="status" id="status">
        <option value="todos">Todos</option>
        <option value="Aberto">Abertos</option>
        <option value="Em andamento">Em andamento</option>
        <option value="Resolvido">Resolvidos</option>
        <option value="Fechado">Fechados</option>
      </select>
    </div>

    <div class="filtro-btn-full">
      <button type="submit">Filtrar</button>
    </div>
  </form>

  {# Feedback de total de resultados #}
  {% if total_geral %}
    <div class="table-feedback">
      Filtro está exibindo {{ total_filtrados }} chamados (de {{ total_geral }})
    </div>
  {% endif %}

  {# Tabela de chamados #}
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Responsável</th>
        <th>Data</th>
        <th>Cliente</th>
        <th>Empresa</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody class="tabela-chamados-corpo">
      {% for chamado in chamados %}
        <tr>
          <td>{{ chamado.id }}</td>
          <td>{{ chamado.responsavel_atendimento }}</td>
          <td>{{ chamado.data }}</td>
          <td>{{ chamado.cliente }}</td>
          <td>{{ chamado.empresa }}</td>
          <td>{{ chamado.status }}</td>
          <td class="botoes-lista-chamados">
            <div class="acoes-flex">

              {# Link para edição com filtros na URL #}
              <a href="#" onclick="carregarConteudo('editar/{{ chamado.id }}?{{ request.query_string.decode() }}')" title="Editar chamado">
                <img src="{{ url_for('static', filename='img/editar.png') }}" alt="Editar" width="14" height="14"> Editar
              </a>

              {% if session["is_admin"] == 1 %}
              <form action="/excluir/{{ chamado.id }}" method="POST" data-spa-post onsubmit="return confirm('Tem certeza que deseja excluir este chamado?')" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="status" value="{{ request.args.get('status', 'todos') }}">
                <input type="hidden" name="empresa" value="{{ request.args.get('empresa', '') }}">
                <input type="hidden" name="responsavel" value="{{ request.args.get('responsavel', '') }}">
                <input type="hidden" name="cliente" value="{{ request.args.get('cliente', '') }}">
                <input type="hidden" name="data_inicio" value="{{ request.args.get('data_inicio', '') }}">
                <input type="hidden" name="data_fim" value="{{ request.args.get('data_fim', '') }}">
                <button type="submit" class="botao-link">
                  <img src="{{ url_for('static', filename='img/cruz.png') }}" alt="Excluir" width="14" height="14"> Excluir
                </button>
              </form>
              {% endif %}

              {# Link para histórico com filtros na URL #}
              <a href="#" onclick="carregarConteudo('historico/{{ chamado.id }}?{{ request.query_string.decode() }}')" title="Histórico do chamado">
                <img src="{{ url_for('static', filename='img/documento.png') }}" alt="Histórico" width="14" height="14"> Histórico
              </a>

            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</main>
